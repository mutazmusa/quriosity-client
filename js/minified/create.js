var a_id=2;function initPageJS(){var a=$("#create-box").offset();$("#control-panel").css({left:a.left+945,top:$(window).scrollTop()+280+"px",position:"absolute"});$("#reset-set").click(function(){var d=confirm("Are you sure you want to clear the set and start over?");if(d){$("textarea").val("");$(".correct-answer").removeClass("correct-answer");$("#QuestionSetTitle").val("")}});addQuestion.maxQuestions=20;$("textarea").elastic();refreshQuestionNumbers();initAnswerLetters();initQuestionContainer($(".question-container"));initAnswerRow($(".answer-row"));$("#nav-basics").click(function(){$("#questions-page").hide();$("#options-page").hide();$("#basics-page").fadeIn();$(".selected").removeClass("selected");$(this).addClass("selected");$("#basics-number").addClass("selected");return false});$("#nav-questions").click(function(){$("#questions-page").fadeIn();$("#options-page").hide();$("#basics-page").hide();$(".selected").removeClass("selected");$(this).addClass("selected");$("#questions-number").addClass("selected");return false});$("#nav-options").click(function(){$("#questions-page").hide();$("#options-page").fadeIn();$("#basics-page").hide();$(".selected").removeClass("selected");$("#nav-options").addClass("selected");$("#options-number").addClass("selected");return false});$("#add-question").click(function(){addQuestion()});$("#next-button-1").click(function(){$("#nav-questions").click()});$("#save-set").click(function(){$("#QuestionSetPublished").val(0);$("#createSetForm").submit()});$("#publish-set").click(function(){var d=confirm("Are you sure you want to publish this set.\nOnce the set is published it cannot be edited.");if(d){$("#QuestionSetPublished").val(1);$("#createSetForm").submit()}return false});$("#createSetForm").submit(function(){$("#loading-img").show();$.post("question_sets/save",$(this).serializeArray(),afterValidate,"json");return false});$("#dialog_link, ul#icons li").hover(function(){$(this).addClass("ui-state-hover")},function(){$(this).removeClass("ui-state-hover")});initInput();$(window).resize(function(){$(window).scroll()});$(window).scroll(function(){var d=$("#create-box").offset();$("#control-panel").css("left",$("#create-box").width()+d.left-5);if($(window).scrollTop()+169<(d.top+80)){return false}if(parseInt($("#control-panel").css("top"))>d.top+parseInt($("#create-box").css("height"))-20-parseInt($("#control-panel").css("height"))){$("#control-panel").css("top",d.top+parseInt($("#create-box").css("height"))-20-parseInt($("#control-panel").css("height"))+"px");return false}if($(window).scrollTop()+169>d.top+parseInt($("#create-box").css("height"))-20-parseInt($("#control-panel").css("height"))){return false}$("#control-panel").css({left:d.left+945,position:"absolute"});$("#control-panel").animate({top:$(window).scrollTop()+169+"px",},{queue:false,duration:600})});function b(d){return d.split(/,\s*/)}function c(d){return b(d).pop()}$("#tags").bind("keydown",function(d){if(d.keyCode===$.ui.keyCode.TAB&&$(this).data("autocomplete").menu.active){d.preventDefault()}}).autocomplete({minLength:0,source:function(e,d){$.getJSON("tags/fetch",{term:c(e.term)},d)},minLength:2,focus:function(){return false},select:function(e,f){var d=b(this.value);d.pop();d.push(f.item.value);d.push("");this.value=d.join(", ");return false}})}function initAnswerLetters(){var b=$("div[id^='explanation-']").last();for(var a=0;a<=parseInt(b.attr("id").substr(12,1));a++){refreshAnswerLetters(a)}}function addQuestion(){if($("#question-space").children().length==addQuestion.maxQuestions){flashQuestionCounter();return false}if(typeof addQuestion.q_number=="undefined"){addQuestion.q_number=10}else{if(addQuestion.q_number==50){flashMessage("Maximum of 50 questions")}}if(typeof addQuestion.nextQIndex=="undefined"){addQuestion.nextQIndex=10}var b=addQuestion.nextQIndex;var a="<div class='full-question question-container' id='question-"+(b)+"'>    <div class='question-head'>        <span class='question-label'></span>        <div class='question-toolbar'>            <div class='delete-question' id='delete-question-index-"+(b)+"'></div>            <div class='add-answer'></div>            <div class='toggle-explanation toggle-explanation-on'></div>        </div>    </div>    <div class='question-body'>        <div class='question-prompt form-row'>            <textarea id='Question"+(b)+"Prompt' cols='30' rows='1' class='input-inside prompt' name='data[Question]["+(b)+"][prompt]'></textarea><input type='hidden' id='Question"+(b)+"QuestionId' value='0' name='data[Question]["+(b)+"][question_id]'><input type='hidden' value='' name='data[Question]["+(b)+"][Answer][correct]' id='hidden-correct-"+(b)+"'>        </div>        <div id='answer-space-"+(b)+"'>        </div>        <div id='explanation-"+(b)+"' class='explanation-space'>            <div class='form-row'>                <span class='explanation-label'>Explanation</span>                <span class='input'><textarea id='Question"+(b)+"Explanation' cols='30' rows='1' class='input-inside prompt' name='data[Question]["+(b)+"][explanation]'></textarea></span>            </div>        </div>    </div></div>";$("#question-space").append(a);$("#question"+b).fadeIn("slow");addAnswer(b,2,false);addQuestion.q_number++;addQuestion.nextQIndex++;initQuestionContainer($(".question-container:last"));refreshQuestionNumbers();return false}function addAnswer(f,c,b){if(typeof c=="undefined"){c=1}if(typeof b=="undefined"){b=true}var e="";if(b){e="<div class='delete-answer' name='delete-question-index-"+(f)+"' id='delete-answer-index-"+(a_id)+"'></div>"}for(var a=0;a<c;a++){var d="<div class='form-row answer-row' id='answer-"+(a_id)+"'>\n          <span class='form-label answer-label'></span>          <span class='answer-toolbar'>          <div class='correct-toggle' name='correct-toggle-question-index-"+(f)+"' id='correct-toggle-answer-index-"+(a_id)+"'></div>          "+e+"          </span>          <span class='input'><textarea id='Question"+(f)+"Answer"+(a_id)+"Prompt' cols='30' rows='1' class='input-inside answer-prompt' name='data[Question]["+(f)+"][Answer]["+(a_id)+"][prompt]'></textarea>          <input type='hidden' id='Question"+(f)+"Answer"+(a_id)+"AnswerId' value='0' name='data[Question]["+(f)+"][Answer]["+(a_id)+"][answer_id]'></span>          </div>";$("#answer-space-"+(f)).append(d);initAnswerRow($("#question-"+f).find(".answer-row").last());a_id++}markUnsavedQuestion(f);initInput();refreshAnswerLetters(f);return false}function removeQuestion(a){addQuestion.q_number--;$("#question-"+a).slideUp("fast",function(){$(this).remove();refreshQuestionNumbers()});return false}function removeAnswer(b,a){$("#answer-"+b).remove();refreshAnswerLetters(a)}function refreshQuestionNumbers(){var a=1;$(".question-label").each(function(){$(this).html("Question "+a++)});flashQuestionCounter()}function refreshAnswerLetters(e){var a=65;var d=$("#question-"+e).find(".answer-label");for(var b=0;b<d.length;b++){$(d[b]).html(itoc(a++))}return false}function itoc(a){return String.fromCharCode(a)}function styleAsSaved(){$("textarea").addClass("saved-input");$("#basics-page").find("input").addClass("saved-input");$("#basics-page").find("select").addClass("saved-input");$(".question-container").addClass("saved-question-container");$(".question-head").addClass("saved-question-head");$("#loading-img").hide()}function afterValidate(b,a){$(".message").remove();$(".error-message").remove();if(b.errors){onError(b.errors)}else{if(b.success){onSuccess(b.success)}}}function onSuccess(a){flashMessage(a.message);if(a.published){disableForm()}$("#QuestionSetSetId").val(a.ids.setId);$.each(a.ids.questionIds,function(c,b){$("#Question"+c+"QuestionId").val(b);$.each(a.ids.answerIds[c],function(d,e){$("#Question"+c+"Answer"+d+"AnswerId").val(e)})});if(a.guest){$("#cb-span").html("<form id='signinupToSaveForm' method='post'><input type='hidden' name='cb' value='ss'></form>");$("#sign-in-to-save-link").click(function(){$("#signinupToSaveForm").attr("action","signin").submit()});$("#sign-up-to-save-link").click(function(){$("#signinupToSaveForm").attr("action","signup").submit()})}styleAsSaved();$("#loading-img").hide()}function onError(c){var b="";var a="";flashMessage(c.message);console.log(c.data);$.each(c.data,function(e,f){if(e=="published"){disableForm();$("#loading-img").hide();return false}if(e=="failure"){$("#loading-img").hide();return false}if((e=="Question")||(e=="Answer")){for(index in this){for(fieldName in this[index]){if(e=="Answer"){var d=index.split(":");b=$("#"+camelize("Question"+d[0]+"Answer"+d[1]+"_"+fieldName))}else{b=$("#"+camelize(e+index+"_"+fieldName))}a=$(document.createElement("div")).insertAfter(b);a.addClass("error-message").text(this[index][fieldName])}}}else{for(fieldName in this){b=$("#"+camelize(e+"_"+fieldName));a=$(document.createElement("div")).insertAfter(b);a.addClass("error-message").text(this[fieldName])}}$("#loading-img").hide()})}function disableForm(){$("#basics-page").find("input").attr("disabled","disabled");$("textarea").attr("disabled","disabled");$(".correct-toggle").unbind("click");$(".toggle-explanation").unbind("click");$(".add-answer").unbind("click");$(".delete-question").unbind("click");$(".question-container").unbind("mouseover");$(".answer-row").unbind("mouseover");$("#add-question").unbind("click");$("#control-panel").hide()}function initQuestionContainer(a){a.find(".delete-question").click(function(){if($(".question-container").length==1){return false}$(this).parents(".question-container").remove();refreshQuestionNumbers()});a.find(".toggle-explanation").click(function(){var b=$(this).parents(".question-container").find(".explanation-space");if(b.is(":visible")){b.hide();b.find("textarea").val("");$(this).removeClass("toggle-explanation-on")}else{b.show();$(this).addClass("toggle-explanation-on")}});a.find(".add-answer").click(function(){var b=$(this).parents(".question-container").attr("id").substr(9);if($("#answer-space-"+b).children().length>5){return false}addAnswer(b,1,true)});a.hover(function(){$(this).find(".question-toolbar").show()},function(){$(this).find(".question-toolbar").hide()});a.find("textarea").elastic()}function initAnswerRow(a){a.hover(function(){$(this).find(".answer-toolbar").show()},function(){$(this).find(".answer-toolbar").hide()});a.find(".correct-toggle").click(function(){if($(this).parents(".answer-row").is(".correct-answer")){return false}var c=$(this).attr("name").substr(30);var b=$(this).attr("id").substr(28);$("[name="+$(this).attr("name")+"]").each(function(){$(this).removeClass("correct-toggle-on");$(this).parents(".answer-row").removeClass("correct-answer")});$("#hidden-correct-"+c).val(b);$(this).parents(".answer-row").addClass("correct-answer");$(this).addClass("correct-toggle-on");markUnsavedQuestion(c)});a.find(".delete-answer").click(function(){var b=$(this).attr("name").substr(22);$(this).parents(".answer-row").remove();markUnsavedQuestion(b);refreshAnswerLetters(b)});a.find("textarea").elastic()}function flashMessage(c,b){$("#message").html(c).fadeIn();$("#message-box").fadeIn();$("html, body").animate({scrollTop:$("#create-box").offset().top},1000);if(b){return false}var a=$(document.createElement("div")).css("display","none");a.attr("id","flashMessage").addClass("message").text(c);a.insertBefore($("#mid")).fadeIn()}function camelize(c){var b=c.split("_"),d;s=[];for(d=0;d<b.length;d++){s.push(b[d].charAt(0).toUpperCase()+b[d].substring(1))}s=s.join("");return s}function initInput(){$(":input").change(function(){$(this).removeClass("saved-input");$(this).parents(".question-container").removeClass("saved-question-container");$(this).parents(".question-container").find(".question-head").removeClass("saved-question-head")})}function markUnsavedQuestion(a){$("#question-"+a).removeClass("saved-question-container");$("#question-"+a).children(".question-head").removeClass("saved-question-head");markUnsavedQuestion.unsaved=true}function flashQuestionCounter(){var a=$(".question-container").length;if((a==addQuestion.maxQuestions||a==1)&&!($("#question-counter").css("color")=="#F6402D")){$("#question-counter").css("color","#F6402D")}else{$("#question-counter").css("color","#D9D9D9")}$("#question-counter").html(a).fadeIn(100).delay(500).fadeOut(100)};